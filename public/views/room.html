<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <title>Pelusa chat</title>
</head>
<body>
<div class="container mt-5">
    <h3>Welcome, {{ .nick }} ğŸ‘‹</h3>
    <div class="row mt-4">
        <!-- èŠå¤©åŒº -->
        <div class="col-8">
            <div class="mb-2">
                <label class="form-label">Chat Mode</label><br>
                <label class="me-3"><input type="radio" name="mode" value="group" checked> ç¾¤èŠ</label>
                <label><input type="radio" name="mode" value="private"> ç§èŠ</label>
            </div>

            <div class="mb-2">
                <label class="form-label">Destination</label>
                <input id="destination" class="form-control form-control-sm" type="text" placeholder="Destination Idï¼ˆä»…ç§èŠéœ€è¦ï¼‰">
                <div class="form-text" id="selectedUserHint">æœªé€‰æ‹©ç›®æ ‡ç”¨æˆ·ï¼Œå¯æ‰‹åŠ¨è¾“å…¥ ID æˆ–åœ¨å³ä¾§ç‚¹å‡»ç”¨æˆ·</div>
            </div>

            <div class="mb-2">
                <label class="form-label">Message</label>
                <input id="message_content" class="form-control form-control-sm" type="text" placeholder="Message...">
            </div>
            <button class="btn btn-dark btn-sm" id="sendTest">Send</button>

            <div class="border rounded p-2 mt-3" style="height: 360px; overflow:auto;">
                <div id="messages"></div>
            </div>
        </div>

        <!-- åœ¨çº¿ç”¨æˆ·æ  -->
        <div class="col-4">
            <div class="d-flex align-items-center justify-content-between">
                <h5 class="mb-0">Online Users</h5>
                <button class="btn btn-outline-secondary btn-sm" id="refreshUsers">Refresh</button>
            </div>
            <ul class="list-group mt-2" id="usersList"></ul>
        </div>
    </div>
</div>

<script>
    // é˜²æ­¢è„šæœ¬é‡å¤æ‰§è¡Œå¯¼è‡´çš„é‡å¤ç»‘å®š/é‡å¤å®šæ—¶å™¨
    if (window.__PELUSA_CHAT_INIT__) {
        console.warn("Pelusa chat already initialized.");
    } else {
        window.__PELUSA_CHAT_INIT__ = true;

        const nick = "{{ .nick }}";
        const registerUrl = "ws://localhost:3000/api/ws/register/" + encodeURIComponent(nick);
        const conn = new WebSocket(registerUrl);

        // ç¼“å­˜å¸¸ç”¨é€‰æ‹©å™¨ï¼Œé¿å…é‡å¤æŸ¥è¯¢
        const $messages = $("#messages");
        const $sendBtn = $("#sendTest");
        const $msgInput = $("#message_content");
        const $destInput = $("#destination");
        const $usersList = $("#usersList");
        const $refreshUsers = $("#refreshUsers");

        // å·¥å…·å‡½æ•°ï¼šæ–‡æœ¬è½¬ä¹‰
        const safe = (s) => $("<div>").text(s || "").html();

        // åŠ è½½åœ¨çº¿ç”¨æˆ·ï¼ˆä¸åŒ…å«è‡ªå·±ï¼‰
        function loadUsers() {
            $.getJSON(`/api/clients?exclude=${encodeURIComponent(nick)}`, (users) => {
                // æ¸²æŸ“åˆ—è¡¨ï¼ˆä»…æ›¿æ¢ DOMï¼Œä¸åœ¨è¿™é‡Œé€é¡¹ç»‘å®šäº‹ä»¶ï¼‰
                const items = users.map(u => (
                    `<li class="list-group-item d-flex justify-content-between align-items-center" data-id="${safe(u.id)}" data-name="${safe(u.name)}">
             <span>${safe(u.name)} <small class="text-muted">(${safe(u.id)})</small></span>
             <button class="btn btn-sm btn-outline-primary user-chat-btn">Chat</button>
           </li>`
                ));
                $usersList.html(items.join(""));
            });
        }

        // äº‹ä»¶ï¼šåˆ·æ–°æŒ‰é’®ï¼ˆåªç»‘å®šä¸€æ¬¡ï¼‰
        $refreshUsers.off("click").on("click", loadUsers);

        // äº‹ä»¶ï¼šç”¨æˆ·åˆ—è¡¨ç‚¹å‡»ï¼ˆäº‹ä»¶å§”æ‰˜ï¼Œåªç»‘å®šä¸€æ¬¡ï¼‰
        $usersList.off("click", ".user-chat-btn").on("click", ".user-chat-btn", function () {
            const $li = $(this).closest("li");
            const id = $li.data("id");
            const name = $li.data("name");
            $destInput.val(id);
            $("#selectedUserHint").text(`å·²é€‰æ‹©å¯¹è¯å¯¹è±¡ï¼š${name} (${id})`);
            $('input[name="mode"][value="private"]').prop("checked", true);
        });

        // äº‹ä»¶ï¼šå‘é€æŒ‰é’®ï¼ˆåªç»‘å®šä¸€æ¬¡ï¼‰
        $sendBtn.off("click").on("click", () => {
            const mode = $('input[name="mode"]:checked').val(); // group or private
            const content = $msgInput.val().trim();
            if (!content) return;

            let payload = {};
            if (mode === "group") {
                payload = { content, broadcast: true };
                // UI å…ˆå›æ˜¾ç¾¤èŠ
                $messages.append(`<p class="text-primary mb-1">[Group] You: ${safe(content)}</p>`);
            } else {
                const dest = $destInput.val().trim();
                if (!dest) { alert("è¯·é€‰æ‹©æˆ–å¡«å†™ Destination Id"); return; }
                payload = { destination_id: dest, content, broadcast: false };
                // UI å›æ˜¾ç§èŠ
                $messages.append(`<p class="text-primary mb-1">[Private] You â†’ (${safe(dest)}): ${safe(content)}</p>`);
            }
            conn.send(JSON.stringify(payload));
            $msgInput.val("");
        });

        // WebSocket æ”¶æ¶ˆæ¯ï¼ˆåªèµ‹å€¼ä¸€æ¬¡ï¼‰
        conn.onmessage = (evt) => {
            const data = JSON.parse(evt.data || "{}");

            if (data.broadcast) {
                if ((data.origin_name || "").toLowerCase() === "manager") {
                    // ç³»ç»Ÿå¹¿æ’­ï¼šåŠ å…¥/ç¦»å¼€
                    $messages.append(`<p class="text-muted mb-1">${safe(data.content)}</p>`);
                    loadUsers(); // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
                } else {
                    // ç¾¤èŠæ¶ˆæ¯
                    const from = data.origin_name ? `${data.origin_name} (${data.origin_id})` : data.origin_id;
                    $messages.append(`<p class="text-danger mb-1">[Group] ${safe(from)}: ${safe(data.content)}</p>`);
                }
            } else {
                // ç§èŠ
                const from = data.origin_name ? `${data.origin_name} (${data.origin_id})` : data.origin_id;
                $messages.append(`<p class="text-danger mb-1">[Private] ${safe(data.content)} â† ${safe(from)}</p>`);
            }
            // æ»šåŠ¨åˆ°åº•éƒ¨
            $messages.parent()[0].scrollTop = $messages.parent()[0].scrollHeight;
        };

        // åˆå§‹åŠ è½½ + è½®è¯¢ï¼ˆé¿å…é‡å¤è®¾ç½®å®šæ—¶å™¨ï¼‰
        loadUsers();
        if (window.__PELUSA_CHAT_USERS_INTERVAL__) clearInterval(window.__PELUSA_CHAT_USERS_INTERVAL__);
        window.__PELUSA_CHAT_USERS_INTERVAL__ = setInterval(loadUsers, 5000);
    }
</script>

</body>
</html>
